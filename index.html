<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CELP - Manutenção (Supabase)</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { color: #000 !important; }
    .stats-card { @apply bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100; }
    .stats-card:hover { transform: translateY(-2px); }
    .form-input { @apply w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 bg-white; }
    .form-label { @apply block text-sm font-medium mb-2; }
    .form-select { @apply w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white transition-all duration-200; }
    .btn-primary { @apply px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all duration-200 border-0 bg-gradient-to-r from-purple-500 to-indigo-600 text-white; }
    .btn-secondary { @apply bg-white px-6 py-3 rounded-xl font-medium hover:bg-gray-50 transition-all duration-200 border border-gray-300; }
    .btn-danger { @apply px-6 py-3 rounded-xl font-medium hover:shadow-lg transition-all duration-200 border-0 bg-gradient-to-r from-red-500 to-pink-600 text-white; }
    .alert-success { @apply bg-green-50 border border-green-200 rounded-xl p-4 mb-4; }
    .alert-error { @apply bg-red-50 border border-red-200 rounded-xl p-4 mb-4; }
    .task-card { @apply bg-white rounded-2xl p-4 shadow-sm hover:shadow-md transition-all duration-200 border border-gray-100; }
    .status-badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
    .priority-badge { @apply px-3 py-1 rounded-full text-xs font-semibold; }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, createContext, useContext } = React;

    const supabase = window.supabase.createClient("https://padojgpykxphlrliphsh.supabase.com", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhZG9qZ3B5a3hwaGxybGlwaHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NDUyMjIsImV4cCI6MjA3MjAyMTIyMn0.nBc6gzba0tq2_65oV25v_pGBOCSduK6QMZtWxBDTLK0");

    const NotificationCtx = createContext();
    function useNotification(){ return useContext(NotificationCtx); }
    function NotificationProvider({children}){
      const [note, setNote] = useState(null);
      const show = (message, type='success') => setNote({message, type});
      const hide = () => setNote(null);
      return (
        <NotificationCtx.Provider value={{show, hide}}>
          {children}
          {note && (
            <div className={"fixed top-4 right-4 z-50 " + (note.type==='success'?'alert-success':'alert-error')}>
              <div className="flex items-center justify-between">
                <span>{note.message}</span>
                <button onClick={hide} className="ml-4 font-bold">&times;</button>
              </div>
            </div>
          )}
        </NotificationCtx.Provider>
      );
    }

    const AuthCtx = createContext();
    function useAuth(){ return useContext(AuthCtx); }
    function AuthProvider({children}){
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);
      const {show} = useNotification();

      useEffect(() => {
        (async () => {
          const { data: { session } } = await supabase.auth.getSession();
          if (session) {
            setUser(session.user);
            await loadProfile(session.user);
          }
          setLoading(false);
        })();
        const { data: sub } = supabase.auth.onAuthStateChange(async (event, session) => {
          if (event === 'SIGNED_IN') {
            setUser(session.user);
            await loadProfile(session.user);
          } else if (event === 'SIGNED_OUT') {
            setUser(null);
            setProfile(null);
          }
        });
        return () => sub.subscription.unsubscribe();
      }, []);

      async function loadProfile(authUser) {
        const { data, error } = await supabase.from('users').select('*').eq('email', authUser.email).limit(1);
        if (!error && data && data.length) setProfile(data[0]);
      }

      async function login(email, password) {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw new Error(error.message);
        show('Sessão iniciada');
        return true;
      }

      async function logout() {
        await supabase.auth.signOut();
        show('Sessão terminada');
      }

      return (
        <AuthCtx.Provider value={{ user, profile, loading, login, logout, reloadProfile: loadProfile }}>
          {children}
        </AuthCtx.Provider>
      );
    }

    const API = {
      async listUsers() {
        const { data, error } = await supabase.from('users').select('*').eq('ativo', true).order('nome');
        if (error) throw new Error(error.message);
        return data;
      },
      async createUser({nome, email, cargo, senha}) {
        const { data, error } = await supabase.auth.signUp({
          email, password: senha,
          options: { emailRedirectTo: window.location.href }
        });
        if (error) throw new Error(error.message);
        const authId = data?.user?.id || null;
        const ins = await supabase.from('users').insert([{
          nome, email, cargo, ativo: true, auth_user_id: authId
        }]).select().single();
        if (ins.error) throw new Error(ins.error.message);
        return ins.data;
      },
      async updateUser(id, updates) {
        const safe = {...updates};
        delete safe.senha;
        const { data, error } = await supabase.from('users').update(safe).eq('id', id).select().single();
        if (error) throw new Error(error.message);
        return data;
      },
      async deactivateUser(id) {
        const { error } = await supabase.from('users').update({ativo:false}).eq('id', id);
        if (error) throw new Error(error.message);
        return true;
      },
      async sendResetPassword(email) {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.href
        });
        if (error) throw new Error(error.message);
        return true;
      },

      async listTasks(filters={}) {
        let q = supabase.from('tasks').select('*');
        if (filters.status) q = q.eq('status', filters.status);
        if (filters.categoria) q = q.eq('categoria', filters.categoria);
        if (filters.atribuido_a) q = q.eq('atribuido_a', filters.atribuido_a);
        if (filters.projeto_id) q = q.eq('projeto_id', filters.projeto_id);
        const { data, error } = await q.order('created_at', {ascending:false});
        if (error) throw new Error(error.message);
        return data || [];
      },
      async createTask(payload) {
        const { data, error } = await supabase.from('tasks').insert([payload]).select().single();
        if (error) throw new Error(error.message);
        return data;
      },
      async updateTask(id, updates) {
        const { data, error } = await supabase
          .from('tasks')
          .update({...updates, updated_at: new Date().toISOString()})
          .eq('id', id).select().single();
        if (error) throw new Error(error.message);
        return data;
      },
      async deleteTask(id) {
        const { error } = await supabase.from('tasks').delete().eq('id', id);
        if (error) throw new Error(error.message);
        return true;
      },

      async listProjects() {
        const { data, error } = await supabase.from('projects').select('*').order('created_at', {ascending:false});
        if (error) throw new Error(error.message);
        return data || [];
      },
      async createProject(payload) {
        const { data, error } = await supabase.from('projects').insert([payload]).select().single();
        if (error) throw new Error(error.message);
        return data;
      },
      async updateProject(id, updates) {
        const { data, error } = await supabase.from('projects').update(updates).eq('id', id).select().single();
        if (error) throw new Error(error.message);
        return data;
      },
      async deleteProject(id) {
        const { error } = await supabase.from('projects').delete().eq('id', id);
        if (error) throw new Error(error.message);
        return true;
      },
    };

    function TopBar() {
      const { user, profile, logout } = useAuth();
      return (
        <div className="bg-white shadow-sm border-b border-gray-200">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div>
              <h1 className="text-xl font-bold">Sistema de Manutenção</h1>
              <p className="text-sm text-gray-600">EPL - CELP</p>
            </div>
            <div className="flex items-center space-x-2">
              <span className="text-sm mr-2">{profile?.nome || user?.email}</span>
              <button onClick={handleResetConfirm} className="btn-secondary" title="Limpa caches locais e termina sessão">Resetar sistema</button>
              <button onClick={logout} className="btn-danger">Terminar sessão</button>
            </div>
          </div>
        </div>
      );
    }

    function handleResetConfirm(){
      if (confirm('Isto vai limpar qualquer cache local e terminar a sessão. Continuar?')) {
        try { ['celp_users','celp_user','celp_token','celp_tasks','celp_projects'].forEach(k => localStorage.removeItem(k)); } catch(e){}
        supabase.auth.signOut();
        window.location.reload();
      }
    }

    function Dashboard() {
      const [stats, setStats] = useState(null);
      useEffect(() => {
        (async () => {
          const tasks = await API.listTasks();
          const projects = await API.listProjects();
          const s = {
            total_tasks: tasks.length,
            pending_tasks: tasks.filter(t=>t.status==='pendente').length,
            in_progress_tasks: tasks.filter(t=>t.status==='em_progresso').length,
            completed_tasks: tasks.filter(t=>t.status==='concluida').length,
            total_projects: projects.length,
            active_projects: projects.filter(p=>p.status!=='concluida').length
          };
          setStats(s);
        })();
      }, []);
      if (!stats) return <div className="p-6">A carregar…</div>;
      return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="stats-card"><h3 className="font-semibold">Total de Tarefas</h3><p className="text-3xl font-bold">{stats.total_tasks}</p></div>
          <div className="stats-card"><h3 className="font-semibold">Pendentes</h3><p className="text-3xl font-bold">{stats.pending_tasks}</p></div>
          <div className="stats-card"><h3 className="font-semibold">Projetos Ativos</h3><p className="text-3xl font-bold">{stats.active_projects}</p></div>
        </div>
      );
    }

    function Users() {
      const [users, setUsers] = useState([]);
      const [show, setShow] = useState(false);
      const [editing, setEditing] = useState(null);
      const [form, setForm] = useState({nome:'', email:'', cargo:'tecnico', senha:''});
      const note = useNotification();

      async function refresh(){
        setUsers(await API.listUsers());
      }
      useEffect(()=>{ refresh(); },[]);

      async function submit(e){
        e.preventDefault();
        try {
          if (editing) {
            await API.updateUser(editing.id, form);
            note.show('Utilizador atualizado');
          } else {
            await API.createUser(form);
            note.show('Utilizador criado (foi enviado e-mail de confirmação/reset se configurado)');
          }
          setShow(false); setEditing(null);
          setForm({nome:'', email:'', cargo:'tecnico', senha:''});
          await refresh();
        } catch(err) {
          note.show(err.message || 'Erro', 'error');
        }
      }

      async function deactivate(u){
        if (!confirm('Desativar este utilizador?')) return;
        try { await API.deactivateUser(u.id); note.show('Utilizador desativado'); await refresh(); }
        catch(err){ note.show(err.message, 'error'); }
      }

      async function resetPwd(u){
        try { await API.sendResetPassword(u.email); note.show('Email de redefinição enviado'); }
        catch(err){ note.show(err.message, 'error'); }
      }

      return (
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold">Utilizadores</h2>
            <button onClick={()=>setShow(true)} className="btn-primary">Novo utilizador</button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-2 text-left text-xs font-medium uppercase">Nome</th>
                  <th className="px-4 py-2 text-left text-xs font-medium uppercase">Email</th>
                  <th className="px-4 py-2 text-left text-xs font-medium uppercase">Cargo</th>
                  <th className="px-4 py-2"></th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {users.map(u=>(
                  <tr key={u.id}>
                    <td className="px-4 py-2">{u.nome}</td>
                    <td className="px-4 py-2">{u.email}</td>
                    <td className="px-4 py-2">{u.cargo}</td>
                    <td className="px-4 py-2 text-right space-x-2">
                      <button onClick={()=>{setEditing(u); setForm({nome:u.nome,email:u.email,cargo:u.cargo,senha:''}); setShow(true);}} className="btn-secondary">Editar</button>
                      <button onClick={()=>resetPwd(u)} className="btn-secondary">Reset password</button>
                      <button onClick={()=>deactivate(u)} className="btn-danger">Desativar</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {show && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-lg w-full">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">{editing?'Editar utilizador':'Novo utilizador'}</h3>
                  <button onClick={()=>{setShow(false); setEditing(null);}}>&times;</button>
                </div>
                <form onSubmit={submit} className="space-y-3">
                  <div>
                    <label className="form-label">Nome</label>
                    <input className="form-input" value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} required />
                  </div>
                  <div>
                    <label className="form-label">Email</label>
                    <input type="email" className="form-input" value={form.email} onChange={e=>setForm({...form, email:e.target.value})} required disabled={!!editing} />
                  </div>
                  <div>
                    <label className="form-label">Cargo</label>
                    <select className="form-select" value={form.cargo} onChange={e=>setForm({...form, cargo:e.target.value})}>
                      <option value="tecnico">Técnico</option>
                      <option value="supervisor">Supervisor</option>
                      <option value="chefe">Chefe</option>
                    </select>
                  </div>
                  {!editing && (
                    <div>
                      <label className="form-label">Senha</label>
                      <input type="password" className="form-input" value={form.senha} onChange={e=>setForm({...form, senha:e.target.value})} required />
                    </div>
                  )}
                  <div className="pt-2 flex space-x-2">
                    <button type="submit" className="btn-primary flex-1">{editing?'Atualizar':'Criar'}</button>
                    <button type="button" onClick={()=>{setShow(false); setEditing(null);}} className="btn-secondary flex-1">Cancelar</button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Tasks() {
      const [tasks, setTasks] = useState([]);
      const [users, setUsers] = useState([]);
      const [projects, setProjects] = useState([]);
      const [show, setShow] = useState(false);
      const [editing, setEditing] = useState(null);
      const [form, setForm] = useState({
        titulo:'', descricao:'', categoria:'eletrica', prioridade:'media',
        atribuido_a:'', projeto_id:'', status:'pendente', data_vencimento:''
      });
      const { profile } = useAuth();
      const note = useNotification();

      async function refresh(){
        const [t,u,p] = await Promise.all([API.listTasks(), API.listUsers(), API.listProjects()]);
        setTasks(t); setUsers(u); setProjects(p);
      }
      useEffect(()=>{ refresh(); },[]);

      async function submit(e){
        e.preventDefault();
        try {
          const payload = {...form, criado_por: profile?.id || null};
          if (editing) { await API.updateTask(editing.id, payload); note.show('Tarefa atualizada'); }
          else { await API.createTask(payload); note.show('Tarefa criada'); }
          setShow(false); setEditing(null);
          setForm({titulo:'', descricao:'', categoria:'eletrica', prioridade:'media', atribuido_a:'', projeto_id:'', status:'pendente', data_vencimento:''});
          await refresh();
        } catch(err) { note.show(err.message,'error'); }
      }

      async function remove(t){ if(confirm('Eliminar tarefa?')){ await API.deleteTask(t.id); note.show('Tarefa eliminada'); await refresh(); } }

      return (
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold">Tarefas</h2>
            <button onClick={()=>setShow(true)} className="btn-primary">Nova tarefa</button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {tasks.map(t=>(
              <div key={t.id} className="task-card">
                <div className="flex items-start justify-between">
                  <h3 className="font-semibold">{t.titulo}</h3>
                  <div className="space-x-2">
                    <button onClick={()=>{setEditing(t); setForm({titulo:t.titulo, descricao:t.descricao, categoria:t.categoria||'eletrica', prioridade:t.prioridade||'media', atribuido_a:t.atribuido_a||'', projeto_id:t.projeto_id||'', status:t.status||'pendente', data_vencimento:t.data_vencimento||''}); setShow(true);}} className="btn-secondary">Editar</button>
                    <button onClick={()=>remove(t)} className="btn-danger">Apagar</button>
                  </div>
                </div>
                <p className="text-sm mt-2">{t.descricao}</p>
                <div className="text-xs mt-3 space-x-2">
                  <span className="priority-badge bg-gray-100 px-2 py-1 rounded">{t.prioridade}</span>
                  <span className="status-badge bg-gray-100 px-2 py-1 rounded">{t.status}</span>
                </div>
                {t.atribuido_a && <p className="text-sm mt-2"><b>Atribuído a:</b> {users.find(u=>u.id===t.atribuido_a)?.nome}</p>}
                {t.projeto_id && <p className="text-sm"><b>Projeto:</b> {projects.find(p=>p.id===t.projeto_id)?.nome}</p>}
                {t.data_vencimento && <p className="text-sm"><b>Vencimento:</b> {new Date(t.data_vencimento).toLocaleDateString('pt-BR')}</p>}
              </div>
            ))}
          </div>

          {show && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-lg w-full">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">{editing?'Editar tarefa':'Nova tarefa'}</h3>
                  <button onClick={()=>{setShow(false); setEditing(null);}}>&times;</button>
                </div>
                <form onSubmit={submit} className="space-y-3">
                  <div>
                    <label className="form-label">Título</label>
                    <input className="form-input" value={form.titulo} onChange={e=>setForm({...form, titulo:e.target.value})} required />
                  </div>
                  <div>
                    <label className="form-label">Descrição</label>
                    <textarea className="form-input" rows="3" value={form.descricao} onChange={e=>setForm({...form, descricao:e.target.value})} required />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="form-label">Categoria</label>
                      <select className="form-select" value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})}>
                        <option value="eletrica">Elétrica</option>
                        <option value="canalizacao">Canalização</option>
                        <option value="ac">Ar Condicionado</option>
                        <option value="obras">Obras</option>
                        <option value="reparacoes_gerais">Reparações Gerais</option>
                      </select>
                    </div>
                    <div>
                      <label className="form-label">Prioridade</label>
                      <select className="form-select" value={form.prioridade} onChange={e=>setForm({...form, prioridade:e.target.value})}>
                        <option value="baixa">Baixa</option>
                        <option value="media">Média</option>
                        <option value="alta">Alta</option>
                        <option value="urgente">Urgente</option>
                      </select>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="form-label">Atribuir a</label>
                      <select className="form-select" value={form.atribuido_a} onChange={e=>setForm({...form, atribuido_a:e.target.value})}>
                        <option value="">Não atribuído</option>
                        {users.map(u=> <option key={u.id} value={u.id}>{u.nome} ({u.cargo})</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="form-label">Projeto</label>
                      <select className="form-select" value={form.projeto_id} onChange={e=>setForm({...form, projeto_id:e.target.value})}>
                        <option value="">Sem projeto</option>
                        {projects.map(p=> <option key={p.id} value={p.id}>{p.nome}</option>)}
                      </select>
                    </div>
                  </div>
                  <div>
                    <label className="form-label">Data de vencimento</label>
                    <input type="date" className="form-input" value={form.data_vencimento} onChange={e=>setForm({...form, data_vencimento:e.target.value})} />
                  </div>
                  <div className="pt-2 flex space-x-2">
                    <button type="submit" className="btn-primary flex-1">{editing?'Atualizar':'Criar'}</button>
                    <button type="button" onClick={()=>{setShow(false); setEditing(null);}} className="btn-secondary flex-1">Cancelar</button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Projects(){
      const [projects, setProjects] = useState([]);
      const [show, setShow] = useState(false);
      const [editing, setEditing] = useState(null);
      const [form, setForm] = useState({nome:'', descricao:'', status:'pendente', data_inicio:'', data_fim:''});
      const { profile } = useAuth();
      const note = useNotification();

      async function refresh(){
        setProjects(await API.listProjects());
      }
      useEffect(()=>{ refresh(); },[]);

      async function submit(e){
        e.preventDefault();
        try {
          const payload = {...form, criado_por: profile?.id || null};
          if (editing) { await API.updateProject(editing.id, payload); note.show('Projeto atualizado'); }
          else { await API.createProject(payload); note.show('Projeto criado'); }
          setShow(false); setEditing(null);
          setForm({nome:'', descricao:'', status:'pendente', data_inicio:'', data_fim:''});
          await refresh();
        } catch(err) { note.show(err.message,'error'); }
      }
      async function remove(p){ if(confirm('Eliminar projeto?')){ await API.deleteProject(p.id); note.show('Projeto eliminado'); await refresh(); } }

      return (
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold">Projetos</h2>
            <button onClick={()=>setShow(true)} className="btn-primary">Novo projeto</button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {projects.map(p=>(
              <div key={p.id} className="task-card">
                <div className="flex items-start justify-between">
                  <h3 className="font-semibold">{p.nome}</h3>
                  <div className="space-x-2">
                    <button onClick={()=>{setEditing(p); setForm({nome:p.nome, descricao:p.descricao||'', status:p.status||'pendente', data_inicio:p.data_inicio||'', data_fim:p.data_fim||''}); setShow(true);}} className="btn-secondary">Editar</button>
                    <button onClick={()=>remove(p)} className="btn-danger">Apagar</button>
                  </div>
                </div>
                <p className="text-sm mt-2">{p.descricao}</p>
                <div className="text-xs mt-3 space-x-2">
                  <span className="status-badge bg-gray-100 px-2 py-1 rounded">{p.status}</span>
                </div>
                {p.data_inicio && <p className="text-sm mt-2"><b>Início:</b> {new Date(p.data_inicio).toLocaleDateString('pt-BR')}</p>}
                {p.data_fim && <p className="text-sm"><b>Fim:</b> {new Date(p.data_fim).toLocaleDateString('pt-BR')}</p>}
              </div>
            ))}
          </div>

          {show && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-lg w-full">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">{editing?'Editar projeto':'Novo projeto'}</h3>
                  <button onClick={()=>{setShow(false); setEditing(null);}}>&times;</button>
                </div>
                <form onSubmit={submit} className="space-y-3">
                  <div>
                    <label className="form-label">Nome</label>
                    <input className="form-input" value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} required />
                  </div>
                  <div>
                    <label className="form-label">Descrição</label>
                    <textarea className="form-input" rows="3" value={form.descricao} onChange={e=>setForm({...form, descricao:e.target.value})} required />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="form-label">Início</label>
                      <input type="date" className="form-input" value={form.data_inicio} onChange={e=>setForm({...form, data_inicio:e.target.value})} />
                    </div>
                    <div>
                      <label className="form-label">Fim</label>
                      <input type="date" className="form-input" value={form.data_fim} onChange={e=>setForm({...form, data_fim:e.target.value})} />
                    </div>
                  </div>
                  <div className="pt-2 flex space-x-2">
                    <button type="submit" className="btn-primary flex-1">{editing?'Atualizar':'Criar'}</button>
                    <button type="button" onClick={()=>{setShow(false); setEditing(null);}} className="btn-secondary flex-1">Cancelar</button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Login(){
      const [email, setEmail] = useState('');
      const [senha, setSenha] = useState('');
      const [loading, setLoading] = useState(false);
      const { login } = useAuth();
      const note = useNotification();

      async function submit(e){
        e.preventDefault();
        setLoading(true);
        try { await login(email, senha); }
        catch(err) { note.show(err.message, 'error'); }
        setLoading(false);
      }

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold mb-2">Sistema de Manutenção</h1>
              <p className="text-sm">EPL - CELP</p>
              <p className="text-sm text-purple-600 mt-2">Ligado ao Supabase</p>
            </div>
            <form onSubmit={submit} className="space-y-6">
              <div>
                <label className="form-label">Email</label>
                <input type="email" className="form-input" value={email} onChange={e=>setEmail(e.target.value)} required />
              </div>
              <div>
                <label className="form-label">Senha</label>
                <input type="password" className="form-input" value={senha} onChange={e=>setSenha(e.target.value)} required />
              </div>
              <button type="submit" className="w-full btn-primary" disabled={loading}>{loading?'A entrar…':'Entrar'}</button>
              <button type="button" onClick={handleResetConfirm} className="w-full btn-secondary mt-2">Resetar sistema</button>
            </form>
          </div>
        </div>
      );
    }

    function App(){
      const { user, loading } = useAuth();
      const [tab, setTab] = useState('dashboard');
      if (loading) return <div className="p-6">A carregar…</div>;
      if (!user) return <Login />;
      return (
        <div>
          <TopBar />
          <div className="max-w-6xl mx-auto px-4 py-6">
            <div className="flex space-x-2 mb-6">
              <button onClick={()=>setTab('dashboard')} className={"btn-secondary " + (tab==='dashboard'?'bg-purple-50 border-purple-200':'')}>Dashboard</button>
              <button onClick={()=>setTab('users')} className={"btn-secondary " + (tab==='users'?'bg-purple-50 border-purple-200':'')}>Utilizadores</button>
              <button onClick={()=>setTab('tasks')} className={"btn-secondary " + (tab==='tasks'?'bg-purple-50 border-purple-200':'')}>Tarefas</button>
              <button onClick={()=>setTab('projects')} className={"btn-secondary " + (tab==='projects'?'bg-purple-50 border-purple-200':'')}>Projetos</button>
            </div>
            {tab==='dashboard' && <Dashboard />}
            {tab==='users' && <Users />}
            {tab==='tasks' && <Tasks />}
            {tab==='projects' && <Projects />}
          </div>
        </div>
      );
    }

    const Root = () => (
      <NotificationProvider>
        <AuthProvider>
          <App />
        </AuthProvider>
      </NotificationProvider>
    );

    ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
  </script>
</body>
</html>
