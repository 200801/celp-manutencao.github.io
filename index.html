<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CELP - Manutenção (Supabase)</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .stats-card{background:#fff;border:1px solid #eee;border-radius:1rem;padding:1.25rem;box-shadow:0 1px 4px rgba(0,0,0,.05)}
    .form-input,.form-select{width:100%;padding:.75rem;border:1px solid #d1d5db;border-radius:.75rem;background:#fff}
    .btn{padding:.6rem 1rem;border-radius:.75rem}
    .btn-primary{background:linear-gradient(90deg,#8b5cf6,#4f46e5);color:#fff;border:0}
    .btn-secondary{background:#fff;border:1px solid #d1d5db}
    .btn-danger{background:linear-gradient(90deg,#ef4444,#ec4899);color:#fff;border:0}
    .task-card{background:#fff;border:1px solid #eee;border-radius:1rem;padding:1rem}
    .alert{position:fixed;top:1rem;right:1rem;background:#fff;border:1px solid #eee;border-radius:.75rem;padding:.75rem 1rem;box-shadow:0 2px 10px rgba(0,0,0,.06);z-index:50}
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, createContext, useContext } = React;

    // CONFIGURAÇÃO SUPABASE
    const supabase = window.supabase.createClient(
      "https://padojgpykxphlrliphsh.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhZG9qZ3B5a3hwaGxybGlwaHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NDUyMjIsImV4cCI6MjA3MjAyMTIyMn0.nBc6gzba0tq2_65oV25v_pGBOCSduK6QMZtWxBDTLK0"
    );

    // ---- Notificações ----
    const NotificationCtx = createContext();
    const useNotification = () => useContext(NotificationCtx);
    function NotificationProvider({children}){
      const [msg, setMsg] = useState(null);
      const show = (text, type='ok') => setMsg({text, type});
      const hide = () => setMsg(null);
      return (
        <NotificationCtx.Provider value={{show, hide}}>
          {children}
          {msg && (
            <div className="alert">
              <div className="flex items-center justify-between gap-4">
                <span className={msg.type==='err' ? 'text-red-600' : 'text-green-700'}>{msg.text}</span>
                <button onClick={hide} className="font-bold">&times;</button>
              </div>
            </div>
          )}
        </NotificationCtx.Provider>
      );
    }

    // ---- Autenticação ----
    const AuthCtx = createContext();
    const useAuth = () => useContext(AuthCtx);
    function AuthProvider({children}){
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);
      const note = useNotification();

      useEffect(() => {
        (async () => {
          const { data:{session} } = await supabase.auth.getSession();
          if (session) {
            setUser(session.user);
            await loadProfile(session.user);
          }
          setLoading(false);
        })();

        const { data: sub } = supabase.auth.onAuthStateChange(async (ev, session) => {
          if (ev === 'SIGNED_IN') {
            setUser(session.user);
            await loadProfile(session.user);
          } else if (ev === 'SIGNED_OUT') {
            setUser(null); setProfile(null);
          }
        });
        return () => sub.subscription.unsubscribe();
      }, []);

      async function loadProfile(authUser){
        const { data, error } = await supabase.from('users').select('*').eq('email', authUser.email).limit(1);
        if (!error && data?.length) setProfile(data[0]);
      }

      async function login(email, password){
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw new Error(error.message);
        note.show('Sessão iniciada');
      }
      async function logout(){ await supabase.auth.signOut(); note.show('Sessão terminada'); }

      return (
        <AuthCtx.Provider value={{ user, profile, loading, login, logout, reloadProfile: loadProfile }}>
          {children}
        </AuthCtx.Provider>
      );
    }

    // ---- API ----
    const API = {
      async listUsers(){
        const { data, error } = await supabase.from('users').select('*').eq('ativo', true).order('nome');
        if (error) throw new Error(error.message); return data;
      },
      async createUser({nome, email, cargo, senha}){
        const { data, error } = await supabase.auth.signUp({
          email, password: senha, options: { emailRedirectTo: window.location.href }
        });
        if (error) throw new Error(error.message);
        const authId = data?.user?.id || null;
        const ins = await supabase.from('users').insert([{ nome, email, cargo, ativo:true, auth_user_id: authId }]).select().single();
        if (ins.error) throw new Error(ins.error.message);
        return ins.data;
      },
      async updateUser(id, updates){
        const u = {...updates}; delete u.senha;
        const { data, error } = await supabase.from('users').update(u).eq('id', id).select().single();
        if (error) throw new Error(error.message); return data;
      },
      async deactivateUser(id){
        const { error } = await supabase.from('users').update({ativo:false}).eq('id', id);
        if (error) throw new Error(error.message); return true;
      },
      async sendResetPassword(email){
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });
        if (error) throw new Error(error.message); return true;
      },

      async listTasks(filters={}){
        let q = supabase.from('tasks').select('*');
        if (filters.status) q=q.eq('status', filters.status);
        if (filters.categoria) q=q.eq('categoria', filters.categoria);
        if (filters.atribuido_a) q=q.eq('atribuido_a', filters.atribuido_a);
        if (filters.projeto_id) q=q.eq('projeto_id', filters.projeto_id);
        const { data, error } = await q.order('created_at', {ascending:false});
        if (error) throw new Error(error.message); return data||[];
      },
      async createTask(p){ const { data, error } = await supabase.from('tasks').insert([p]).select().single(); if (error) throw new Error(error.message); return data; },
      async updateTask(id,u){ const { data, error } = await supabase.from('tasks').update({...u,updated_at:new Date().toISOString()}).eq('id',id).select().single(); if (error) throw new Error(error.message); return data; },
      async deleteTask(id){ const { error } = await supabase.from('tasks').delete().eq('id', id); if (error) throw new Error(error.message); return true; },

      async listProjects(){ const { data, error } = await supabase.from('projects').select('*').order('created_at',{ascending:false}); if (error) throw new Error(error.message); return data||[]; },
      async createProject(p){ const { data, error } = await supabase.from('projects').insert([p]).select().single(); if (error) throw new Error(error.message); return data; },
      async updateProject(id,u){ const { data, error } = await supabase.from('projects').update(u).eq('id',id).select().single(); if (error) throw new Error(error.message); return data; },
      async deleteProject(id){ const { error } = await supabase.from('projects').delete().eq('id', id); if (error) throw new Error(error.message); return true; },
    };

    // ---- UI ----
    function resetLocalAndReload(){
      try{ ['celp_users','celp_user','celp_token','celp_tasks','celp_projects'].forEach(k=>localStorage.removeItem(k)); }catch(e){}
      supabase.auth.signOut(); window.location.reload();
    }

    function TopBar(){
      const { user, profile, logout } = useAuth();
      return (
        <div className="bg-white border-b border-gray-200">
          <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div>
              <h1 className="text-xl font-bold">Sistema de Manutenção</h1>
              <p className="text-sm text-gray-600">EPL - CELP</p>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-sm">{profile?.nome || user?.email}</span>
              <button className="btn btn-secondary" onClick={resetLocalAndReload}>Resetar sistema</button>
              <button className="btn btn-danger" onClick={logout}>Terminar sessão</button>
            </div>
          </div>
        </div>
      );
    }

    function Dashboard(){
      const [stats, setStats] = useState(null);
      useEffect(()=>{ (async ()=>{
        const [t,p]=await Promise.all([API.listTasks(), API.listProjects()]);
        setStats({
          total_tasks:t.length,
          pending:t.filter(x=>x.status==='pendente').length,
          inprog:t.filter(x=>x.status==='em_progresso').length,
          done:t.filter(x=>x.status==='concluida').length,
          total_projects:p.length,
          active_projects:p.filter(x=>x.status!=='concluida').length
        });
      })(); },[]);
      if(!stats) return <div className="p-6">A carregar…</div>;
      return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="stats-card"><div className="text-sm">Total de Tarefas</div><div className="text-3xl font-bold">{stats.total_tasks}</div></div>
          <div className="stats-card"><div className="text-sm">Pendentes</div><div className="text-3xl font-bold">{stats.pending}</div></div>
          <div className="stats-card"><div className="text-sm">Projetos Ativos</div><div className="text-3xl font-bold">{stats.active_projects}</div></div>
        </div>
      );
    }

    function Users(){
      const [users,setUsers]=useState([]); const [open,setOpen]=useState(false); const [editing,setEditing]=useState(null);
      const [form,setForm]=useState({nome:'',email:'',cargo:'tecnico',senha:''}); const note=useNotification();

      async function refresh(){ setUsers(await API.listUsers()); }
      useEffect(()=>{ refresh(); },[]);

      async function submit(e){
        e.preventDefault();
        try{
          if(editing){ await API.updateUser(editing.id, form); note.show('Utilizador atualizado'); }
          else{ await API.createUser(form); note.show('Utilizador criado'); }
          setOpen(false); setEditing(null); setForm({nome:'',email:'',cargo:'tecnico',senha:''}); refresh();
        }catch(err){ note.show(err.message,'err'); }
      }
      async function deactivate(u){ if(!confirm('Desativar?')) return; try{ await API.deactivateUser(u.id); note.show('Desativado'); refresh(); }catch(e){ note.show(e.message,'err'); } }
      async function resetPwd(u){ try{ await API.sendResetPassword(u.email); note.show('Email de redefinição enviado'); }catch(e){ note.show(e.message,'err'); } }

      return (
        <div className="bg-white rounded-2xl border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-bold">Utilizadores</h2>
            <button className="btn btn-primary" onClick={()=>setOpen(true)}>Novo utilizador</button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr><th className="p-2 text-left">Nome</th><th className="p-2 text-left">Email</th><th className="p-2 text-left">Cargo</th><th className="p-2"></th></tr>
              </thead>
              <tbody className="divide-y">
                {users.map(u=>(
                  <tr key={u.id}>
                    <td className="p-2">{u.nome}</td>
                    <td className="p-2">{u.email}</td>
                    <td className="p-2">{u.cargo}</td>
                    <td className="p-2 text-right space-x-2">
                      <button className="btn btn-secondary" onClick={()=>{setEditing(u); setForm({nome:u.nome,email:u.email,cargo:u.cargo,senha:''}); setOpen(true);}}>Editar</button>
                      <button className="btn btn-secondary" onClick={()=>resetPwd(u)}>Reset password</button>
                      <button className="btn btn-danger" onClick={()=>deactivate(u)}>Desativar</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {open && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-lg">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-semibold">{editing?'Editar utilizador':'Novo utilizador'}</h3>
                  <button onClick={()=>{setOpen(false); setEditing(null);}}>&times;</button>
                </div>
                <form onSubmit={submit} className="space-y-3">
                  <div><label className="text-sm">Nome</label><input className="form-input" value={form.nome} onChange={e=>setForm({...form,nome:e.target.value})} required /></div>
                  <div><label className="text-sm">Email</label><input type="email" className="form-input" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} required disabled={!!editing} /></div>
                  <div><label className="text-sm">Cargo</label>
                    <select className="form-select" value={form.cargo} onChange={e=>setForm({...form,cargo:e.target.value})}>
                      <option value="tecnico">Técnico</option><option value="supervisor">Supervisor</option><option value="chefe">Chefe</option>
                    </select>
                  </div>
                  {!editing && (<div><label className="text-sm">Senha</label><input type="password" className="form-input" value={form.senha} onChange={e=>setForm({...form,senha:e.target.value})} required /></div>)}
                  <div className="flex gap-2 pt-2"><button className="btn btn-primary flex-1" type="submit">{editing?'Atualizar':'Criar'}</button><button className="btn btn-secondary flex-1" type="button" onClick={()=>{setOpen(false); setEditing(null);}}>Cancelar</button></div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Tasks(){
      const [tasks,setTasks]=useState([]); const [users,setUsers]=useState([]); const [projects,setProjects]=useState([]);
      const [open,setOpen]=useState(false); const [editing,setEditing]=useState(null);
      const [form,setForm]=useState({titulo:'',descricao:'',categoria:'eletrica',prioridade:'media',atribuido_a:'',projeto_id:'',status:'pendente',data_vencimento:''});
      const { profile } = useAuth(); const note = useNotification();

      async function refresh(){ const [t,u,p]=await Promise.all([API.listTasks(),API.listUsers(),API.listProjects()]); setTasks(t); setUsers(u); setProjects(p); }
      useEffect(()=>{ refresh(); },[]);

      async function submit(e){
        e.preventDefault();
        try{
          const payload={...form, criado_por: profile?.id||null};
          if(editing){ await API.updateTask(editing.id,payload); note.show('Tarefa atualizada'); }
          else{ await API.createTask(payload); note.show('Tarefa criada'); }
          setOpen(false); setEditing(null); setForm({titulo:'',descricao:'',categoria:'eletrica',prioridade:'media',atribuido_a:'',projeto_id:'',status:'pendente',data_vencimento:''}); refresh();
        }catch(err){ note.show(err.message,'err'); }
      }
      async function remove(t){ if(confirm('Eliminar tarefa?')){ await API.deleteTask(t.id); note.show('Eliminada'); refresh(); } }

      return (
        <div className="bg-white rounded-2xl border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4"><h2 className="text-lg font-bold">Tarefas</h2><button className="btn btn-primary" onClick={()=>setOpen(true)}>Nova tarefa</button></div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {tasks.map(t=>(
              <div key={t.id} className="task-card">
                <div className="flex items-start justify-between">
                  <h3 className="font-semibold">{t.titulo}</h3>
                  <div className="space-x-2">
                    <button className="btn btn-secondary" onClick={()=>{setEditing(t); setForm({titulo:t.titulo,descricao:t.descricao,categoria:t.categoria||'eletrica',prioridade:t.prioridade||'media',atribuido_a:t.atribuido_a||'',projeto_id:t.projeto_id||'',status:t.status||'pendente',data_vencimento:t.data_vencimento||''}); setOpen(true);}}>Editar</button>
                    <button className="btn btn-danger" onClick={()=>remove(t)}>Apagar</button>
                  </div>
                </div>
                <p className="text-sm mt-1">{t.descricao}</p>
                <div className="text-xs mt-2 space-x-2"><span className="px-2 py-1 bg-gray-100 rounded">{t.prioridade}</span><span className="px-2 py-1 bg-gray-100 rounded">{t.status}</span></div>
                {t.atribuido_a && <p className="text-sm mt-2"><b>Atribuído a:</b> {users.find(u=>u.id===t.atribuido_a)?.nome}</p>}
                {t.projeto_id && <p className="text-sm"><b>Projeto:</b> {projects.find(p=>p.id===t.projeto_id)?.nome}</p>}
                {t.data_vencimento && <p className="text-sm"><b>Vencimento:</b> {new Date(t.data_vencimento).toLocaleDateString('pt-PT')}</p>}
              </div>
            ))}
          </div>

          {open && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-lg">
                <div className="flex items-center justify-between mb-3"><h3 className="font-semibold">{editing?'Editar tarefa':'Nova tarefa'}</h3><button onClick={()=>{setOpen(false); setEditing(null);}}>&times;</button></div>
                <form onSubmit={submit} className="space-y-3">
                  <div><label className="text-sm">Título</label><input className="form-input" value={form.titulo} onChange={e=>setForm({...form,titulo:e.target.value})} required /></div>
                  <div><label className="text-sm">Descrição</label><textarea className="form-input" rows="3" value={form.descricao} onChange={e=>setForm({...form,descricao:e.target.value})} required></textarea></div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="text-sm">Categoria</label>
                      <select className="form-select" value={form.categoria} onChange={e=>setForm({...form,categoria:e.target.value})}>
                        <option value="eletrica">Elétrica</option><option value="canalizacao">Canalização</option><option value="ac">Ar Condicionado</option><option value="obras">Obras</option><option value="reparacoes_gerais">Reparações Gerais</option>
                      </select>
                    </div>
                    <div><label className="text-sm">Prioridade</label>
                      <select className="form-select" value={form.prioridade} onChange={e=>setForm({...form,prioridade:e.target.value})}>
                        <option value="baixa">Baixa</option><option value="media">Média</option><option value="alta">Alta</option><option value="urgente">Urgente</option>
                      </select>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="text-sm">Atribuir a</label>
                      <select className="form-select" value={form.atribuido_a} onChange={e=>setForm({...form,atribuido_a:e.target.value})}>
                        <option value="">Não atribuído</option>
                        {users.map(u=><option key={u.id} value={u.id}>{u.nome} ({u.cargo})</option>)}
                      </select>
                    </div>
                    <div><label className="text-sm">Projeto</label>
                      <select className="form-select" value={form.projeto_id} onChange={e=>setForm({...form,projeto_id:e.target.value})}>
                        <option value="">Sem projeto</option>
                        {projects.map(p=><option key={p.id} value={p.id}>{p.nome}</option>)}
                      </select>
                    </div>
                  </div>
                  <div><label className="text-sm">Data de vencimento</label><input type="date" className="form-input" value={form.data_vencimento} onChange={e=>setForm({...form,data_vencimento:e.target.value})} /></div>
                  <div className="flex gap-2 pt-2"><button className="btn btn-primary flex-1" type="submit">{editing?'Atualizar':'Criar'}</button><button className="btn btn-secondary flex-1" type="button" onClick={()=>{setOpen(false); setEditing(null);}}>Cancelar</button></div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Projects(){
      const [projects,setProjects]=useState([]); const [open,setOpen]=useState(false); const [editing,setEditing]=useState(null);
      const [form,setForm]=useState({nome:'',descricao:'',status:'pendente',data_inicio:'',data_fim:''}); const { profile } = useAuth(); const note = useNotification();

      async function refresh(){ setProjects(await API.listProjects()); }
      useEffect(()=>{ refresh(); },[]);

      async function submit(e){
        e.preventDefault();
        try{
          const payload={...form,criado_por:profile?.id||null};
          if(editing){ await API.updateProject(editing.id,payload); note.show('Projeto atualizado'); }
          else{ await API.createProject(payload); note.show('Projeto criado'); }
          setOpen(false); setEditing(null); setForm({nome:'',descricao:'',status:'pendente',data_inicio:'',data_fim:''}); refresh();
        }catch(err){ note.show(err.message,'err'); }
      }
      async function remove(p){ if(confirm('Eliminar projeto?')){ await API.deleteProject(p.id); note.show('Projeto eliminado'); refresh(); } }

      return (
        <div className="bg-white rounded-2xl border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4"><h2 className="text-lg font-bold">Projetos</h2><button className="btn btn-primary" onClick={()=>setOpen(true)}>Novo projeto</button></div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {projects.map(p=>(
              <div key={p.id} className="task-card">
                <div className="flex items-start justify-between">
                  <h3 className="font-semibold">{p.nome}</h3>
                  <div className="space-x-2">
                    <button className="btn btn-secondary" onClick={()=>{setEditing(p); setForm({nome:p.nome,descricao:p.descricao||'',status:p.status||'pendente',data_inicio:p.data_inicio||'',data_fim:p.data_fim||''}); setOpen(true);}}>Editar</button>
                    <button className="btn btn-danger" onClick={()=>remove(p)}>Apagar</button>
                  </div>
                </div>
                <p className="text-sm mt-1">{p.descricao}</p>
                <div className="text-xs mt-2"><span className="px-2 py-1 bg-gray-100 rounded">{p.status}</span></div>
                {p.data_inicio && <p className="text-sm mt-2"><b>Início:</b> {new Date(p.data_inicio).toLocaleDateString('pt-PT')}</p>}
                {p.data_fim && <p className="text-sm"><b>Fim:</b> {new Date(p.data_fim).toLocaleDateString('pt-PT')}</p>}
              </div>
            ))}
          </div>

          {open && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-lg">
                <div className="flex items-center justify-between mb-3"><h3 className="font-semibold">{editing?'Editar projeto':'Novo projeto'}</h3><button onClick={()=>{setOpen(false); setEditing(null);}}>&times;</button></div>
                <form onSubmit={submit} className="space-y-3">
                  <div><label className="text-sm">Nome</label><input className="form-input" value={form.nome} onChange={e=>setForm({...form,nome:e.target.value})} required /></div>
                  <div><label className="text-sm">Descrição</label><textarea className="form-input" rows="3" value={form.descricao} onChange={e=>setForm({...form,descricao:e.target.value})} required></textarea></div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="text-sm">Início</label><input type="date" className="form-input" value={form.data_inicio} onChange={e=>setForm({...form,data_inicio:e.target.value})} /></div>
                    <div><label className="text-sm">Fim</label><input type="date" className="form-input" value={form.data_fim} onChange={e=>setForm({...form,data_fim:e.target.value})} /></div>
                  </div>
                  <div className="flex gap-2 pt-2"><button className="btn btn-primary flex-1" type="submit">{editing?'Atualizar':'Criar'}</button><button className="btn btn-secondary flex-1" type="button" onClick={()=>{setOpen(false); setEditing(null);}}>Cancelar</button></div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Login(){
      const [email,setEmail]=useState(''); const [senha,setSenha]=useState(''); const [busy,setBusy]=useState(false);
      const { login } = useAuth(); const note=useNotification();
      async function submit(e){ e.preventDefault(); setBusy(true); try{ await login(email,senha);}catch(err){ note.show(err.message,'err'); } setBusy(false); }
      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div className="text-center mb-6"><h1 className="text-2xl font-bold">Sistema de Manutenção</h1><p className="text-sm">EPL - CELP</p><p className="text-xs text-purple-600 mt-1">Ligado ao Supabase</p></div>
            <form onSubmit={submit} className="space-y-4">
              <div><label className="text-sm">Email</label><input type="email" className="form-input" value={email} onChange={e=>setEmail(e.target.value)} required /></div>
              <div><label className="text-sm">Senha</label><input type="password" className="form-input" value={senha} onChange={e=>setSenha(e.target.value)} required /></div>
              <button className="btn btn-primary w-full" disabled={busy}>{busy?'A entrar…':'Entrar'}</button>
              <button type="button" className="btn btn-secondary w-full" onClick={resetLocalAndReload}>Resetar sistema</button>
            </form>
          </div>
        </div>
      );
    }

    function App(){
      const { user, loading } = useAuth();
      const [tab,setTab]=useState('dashboard');
      if(loading) return <div className="p-6">A carregar…</div>;
      if(!user) return <Login />;
      return (
        <div>
          <TopBar />
          <div className="max-w-6xl mx-auto px-4 py-6">
            <div className="flex gap-2 mb-6">
              <button className={"btn btn-secondary "+(tab==='dashboard'?'border-purple-400 bg-purple-50':'')} onClick={()=>setTab('dashboard')}>Dashboard</button>
              <button className={"btn btn-secondary "+(tab==='users'?'border-purple-400 bg-purple-50':'')} onClick={()=>setTab('users')}>Utilizadores</button>
              <button className={"btn btn-secondary "+(tab==='tasks'?'border-purple-400 bg-purple-50':'')} onClick={()=>setTab('tasks')}>Tarefas</button>
              <button className={"btn btn-secondary "+(tab==='projects'?'border-purple-400 bg-purple-50':'')} onClick={()=>setTab('projects')}>Projetos</button>
            </div>
            {tab==='dashboard' && <Dashboard />}
            {tab==='users' && <Users />}
            {tab==='tasks' && <Tasks />}
            {tab==='projects' && <Projects />}
          </div>
        </div>
      );
    }

    const Root = () => (
      <NotificationProvider>
        <AuthProvider>
          <App />
        </AuthProvider>
      </NotificationProvider>
    );
    ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
  </script>
</body>
</html>
